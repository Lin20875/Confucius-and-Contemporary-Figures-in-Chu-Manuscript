<!doctype html>
<html lang="zh-Hant">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>新出土戰國楚簡「孔子與時人對答」讀本</title>
	<style>
		:root { --bg:#f7f7f7; --fg:#1a1a1a; --muted:#666; --accent:#8c1d40; --border:#ddd; }
		html,body{height:100%}
		body{margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft JhengHei",sans-serif; color:var(--fg); background:#fff;}
		.header{padding:12px 16px; border-bottom:1px solid var(--border); background:linear-gradient(135deg, rgba(140,29,64,.06), transparent);}
		.header__title{margin:0; font-size:26px; letter-spacing:.06em;}
		.header__meta{margin:6px 0 0; font-size:13px; color:var(--muted);}
		.layout{display:flex; height:calc(100vh - 78px);}
		.sidebar{width:300px; min-width:260px; max-width:420px; border-right:1px solid var(--border); display:flex; flex-direction:column; background:var(--bg);}
		.sidebar__section{padding:12px 12px 8px; border-bottom:1px solid var(--border);}
		.section__title{margin:0; font-size:14px; color:var(--muted);}
		.list{list-style:none; margin:0; padding:6px 6px 10px; overflow:auto; flex:1;}
		.list__item{margin:4px 0;}
		.link{display:block; padding:8px 10px; border-radius:6px; color:inherit; text-decoration:none;}
		.link:hover{background:#fff; box-shadow:inset 0 0 0 1px var(--border);}
		.link--active{background:#fff; box-shadow:inset 0 0 0 2px var(--accent);}
		.sidebar__footer{padding:10px; border-top:1px solid var(--border); font-size:13px;}
		.search-row{display:flex; gap:6px; margin-top:6px;}
		.input{flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;}
		.btn{padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:6px; cursor:pointer;}
		.btn:active{transform:translateY(1px);}
		.btn--primary{border-color:var(--accent); color:#fff; background:var(--accent);}
		.mutedsm{font-size:12px; color:var(--muted);}
		.checkbox-group{margin-top:10px; padding:8px; background:#fff; border:1px solid var(--border); border-radius:8px; max-height:180px; overflow:auto; display:flex; flex-direction:column; gap:6px;}
		.checkbox-group__item{display:flex; align-items:flex-start; gap:6px; font-size:13px; line-height:1.4;}
		.checkbox-group__item input[type="checkbox"]{margin-top:2px; accent-color:var(--accent);}
		.notice{margin-top:8px; font-size:12px; color:var(--muted);}
		.content{flex:1; display:flex; flex-direction:column; background:#fff;}
		.viewer-wrap{flex:1; position:relative; border-bottom:1px solid var(--border);}
		.viewer{position:absolute; inset:0; width:100%; height:100%; border:0; background:#fff;}
		.results{max-height:40%; min-height:160px; display:flex; flex-direction:column;}
		.results__header{padding:10px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;}
		.results__title{margin:0; font-size:15px;}
		.results__hint{margin:0; font-size:12px; color:var(--muted);}
		.results__list{flex:1; overflow:auto; padding:12px 16px; margin:0;}
		.result{margin-bottom:14px; padding-bottom:14px; border-bottom:1px solid var(--border);}
		.result:last-child{border-bottom:none; margin-bottom:0; padding-bottom:0;}
		.result__article{font-size:13px; color:var(--muted); margin:0 0 6px;}
		.result__excerpt{margin:0; line-height:1.6;}
		.result__mark{background:rgba(140,29,64,.18); color:inherit; padding:0 2px; border-radius:2px;}
		.results__empty{margin:0; font-size:13px; color:var(--muted);}
		@media (max-width:768px){
			.layout{flex-direction:column;}
			.sidebar{width:100%; max-width:none; border-right:none; border-bottom:1px solid var(--border); height:auto;}
			.content{height:calc(100vh - 260px);}
			.viewer-wrap{flex:1;}
			.results{max-height:none;}
			.checkbox-group{max-height:140px;}
		}
	</style>
</head>
<body>
	<header class="header">
		<h1 class="header__title">新出土戰國楚簡「孔子與時人對答」讀本</h1>
		<p class="header__meta">作者：陳曙光博士　｜　網頁開發者：樂林</p>
	</header>
	<div class="layout">
		<aside class="sidebar" aria-label="文章目錄與全文檢索">
			<div class="sidebar__section">
				<p class="section__title">讀本目錄</p>
			</div>
			<ul id="article-list" class="list" aria-label="文章列表"></ul>
			<div class="sidebar__footer" aria-label="全文檢索區">
				<div class="mutedsm">檢索文字</div>
				<div class="search-row">
					<input id="search-input" class="input" type="text" placeholder="輸入欲檢索的文字…" aria-label="檢索文字輸入">
					<button id="search-btn" class="btn btn--primary" type="button">搜尋</button>
				</div>
				<div class="mutedsm" style="margin-top:12px;">勾選欲檢索的文章（可複選）</div>
				<div id="scope-checkboxes" class="checkbox-group" role="group" aria-label="檢索文章範圍"></div>
				<p class="notice">提示：若未勾選任何文章，將以目前閱讀的文章進行檢索。</p>
			</div>
		</aside>
		<main class="content" aria-label="文章檢視與檢索結果">
			<div class="viewer-wrap">
				<iframe id="viewer" class="viewer" src="" title="文章內容預覽"></iframe>
			</div>
			<section class="results" aria-live="polite">
				<div class="results__header">
					<h2 class="results__title">檢索結果</h2>
					<p id="search-hint" class="results__hint">尚未進行檢索</p>
				</div>
				<div id="search-results" class="results__list">
					<p class="results__empty">執行搜尋後，相關段落會顯示於此。</p>
				</div>
			</section>
		</main>
	</div>
	<script>
		(function(){
			const articles = [
				{ title: "君子為禮", path: "articles/君子為禮.html" },
				{ title: "示例文章二（sample-2）", path: "articles/sample-2.html" },
				{ title: "示例文章乙（sample-b）", path: "articles/sample-b.html" }
			];

			const listEl = document.getElementById('article-list');
			const iframe = document.getElementById('viewer');
			const searchInput = document.getElementById('search-input');
			const searchBtn = document.getElementById('search-btn');
			const scopeGroup = document.getElementById('scope-checkboxes');
			const hintEl = document.getElementById('search-hint');
			const resultsEl = document.getElementById('search-results');

			let currentIndex = 0;

			function renderList() {
				listEl.innerHTML = "";
				articles.forEach((a, idx) => {
					const li = document.createElement('li');
					li.className = 'list__item';
					const link = document.createElement('a');
					link.href = '#';
					link.textContent = a.title;
					link.className = 'link' + (idx === currentIndex ? ' link--active' : '');
					link.addEventListener('click', (e) => {
						e.preventDefault();
						if (currentIndex !== idx) {
							currentIndex = idx;
							loadArticle();
							renderList();
							renderScope();
							setHint("已切換至《" + a.title + "》");
						}
					});
					li.appendChild(link);
					listEl.appendChild(li);
				});
			}

			function renderScope() {
				scopeGroup.innerHTML = "";
				articles.forEach((a, idx) => {
					const wrapper = document.createElement('label');
					wrapper.className = 'checkbox-group__item';
					const checkbox = document.createElement('input');
					checkbox.type = 'checkbox';
					checkbox.value = String(idx);
					checkbox.name = 'scope';
					if (idx === currentIndex) {
						checkbox.checked = true;
					}
					const text = document.createElement('span');
					text.textContent = a.title;
					wrapper.appendChild(checkbox);
					wrapper.appendChild(text);
					scopeGroup.appendChild(wrapper);
				});
			}

			function loadArticle() {
				const art = articles[currentIndex];
				iframe.src = art.path;
			}

			function setHint(text){ hintEl.textContent = text; }

			function escapeRegExp(str) {
				return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
			}

			function getSelectedScopeIndices() {
				return Array.from(scopeGroup.querySelectorAll('input[type="checkbox"]:checked'))
					.map(input => parseInt(input.value, 10))
					.filter(idx => Number.isInteger(idx) && idx >= 0 && idx < articles.length);
			}

			async function runSearch() {
				const query = searchInput.value.trim();
				if (!query) {
					setHint("請輸入檢索詞。");
					resultsEl.innerHTML = '<p class="results__empty">尚未輸入檢索詞。</p>';
					return;
				}

				const selectedIndices = getSelectedScopeIndices();
				const articleIndices = selectedIndices.length ? selectedIndices : [currentIndex];

				resultsEl.innerHTML = '<p class="results__empty">檢索中，請稍候…</p>';
				setHint("檢索中…");

				const pattern = new RegExp(escapeRegExp(query), 'gi');
				const results = [];

				for (const idx of articleIndices) {
					const art = articles[idx];
					try {
						const response = await fetch(art.path);
						if (!response.ok) throw new Error("無法載入文章：《" + art.title + "》");
						const htmlText = await response.text();
						const parser = new DOMParser();
						const doc = parser.parseFromString(htmlText, "text/html");

						const segments = Array.from(doc.querySelectorAll('p, li, blockquote, h1, h2, h3, h4'));
						segments.forEach((node) => {
							const text = node.textContent || "";
							if (!text.trim()) return;
							if (pattern.test(text)) {
								const marked = text.replace(pattern, (match) => `<mark class="result__mark">${match}</mark>`);
								results.push({
									articleTitle: art.title,
									excerpt: marked
								});
								pattern.lastIndex = 0;
							} else {
								pattern.lastIndex = 0;
							}
						});
					} catch (err) {
						results.push({
							articleTitle: art.title,
							excerpt: `<span style="color:#b00020;">${err.message}</span>`
						});
					}
				}

				if (!results.length) {
					resultsEl.innerHTML = `<p class="results__empty">未找到包含「${query}」的段落。</p>`;
					setHint("未找到相關內容。");
					return;
				}

				const frag = document.createDocumentFragment();
				results.forEach((item) => {
					const wrapper = document.createElement('article');
					wrapper.className = 'result';
					const title = document.createElement('p');
					title.className = 'result__article';
					title.textContent = "文章：《" + item.articleTitle + "》";
					const excerpt = document.createElement('p');
					excerpt.className = 'result__excerpt';
					excerpt.innerHTML = item.excerpt;
					wrapper.appendChild(title);
					wrapper.appendChild(excerpt);
					frag.appendChild(wrapper);
				});
				resultsEl.innerHTML = "";
				resultsEl.appendChild(frag);
				setHint("找到 " + results.length + " 筆結果。");
			}

			searchBtn.addEventListener('click', runSearch);
			searchInput.addEventListener('keydown', (e) => {
				if (e.key === 'Enter') runSearch();
			});

			renderList();
			renderScope();
			loadArticle();
		})();
	</script>
</body>
</html>