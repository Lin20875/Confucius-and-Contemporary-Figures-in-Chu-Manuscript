<!doctype html>
<html lang="zh-Hant">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>新出土戰國楚簡「孔子與時人對答」讀本</title>
	<style>
		:root { --bg:#f7f7f7; --fg:#1a1a1a; --muted:#666; --accent:#8c1d40; --border:#ddd; }
		html,body{height:100%;}
		body{margin:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft JhengHei",sans-serif; color:var(--fg); background:#fff;}
		[hidden]{display:none !important;}
		.header{padding:14px 18px; border-bottom:1px solid var(--border); background:linear-gradient(135deg, rgba(140,29,64,.08), transparent);}
		.header__title{margin:0; font-size:32px; letter-spacing:.05em; line-height:1.25;}
		.header__meta{margin:8px 0 0; font-size:13px; color:var(--muted);}
		.layout{display:flex; height:calc(100vh - 86px);}
		.sidebar{width:300px; min-width:260px; max-width:420px; border-right:1px solid var(--border); display:flex; flex-direction:column; background:var(--bg); position:relative; transition:transform .3s ease, margin .3s ease;}
		.sidebar.hidden{transform:translateX(-100%); margin-left:-300px;}
		.sidebar__section{padding:12px 12px 8px; border-bottom:1px solid var(--border); user-select:none;}
		.sidebar__header{display:flex; align-items:center; justify-content:space-between; padding:12px 12px 8px; border-bottom:1px solid var(--border);}
		.section__title{margin:0; font-size:14px; color:var(--muted); cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:4px 6px; border-radius:4px; transition:background .15s ease;}
		.section__title:hover{background:rgba(0,0,0,.05);}
		.section__title::after{content:'▼'; font-size:10px; color:var(--muted); transition:transform .2s ease;}
		.section__title.collapsed::after{transform:rotate(-90deg);}
		.sidebar-toggle{background:none; border:none; cursor:pointer; padding:4px 6px; border-radius:4px; color:var(--muted); font-size:14px; transition:all .15s ease; display:flex; align-items:center; justify-content:center; width:28px; height:28px;}
		.sidebar-toggle:hover{background:rgba(0,0,0,.08); color:var(--fg);}
		.sidebar-toggle:active{transform:scale(.9);}
		.list{list-style:none; margin:0; padding:6px 6px 10px; overflow:auto; flex:1; transition:all .3s ease;}
		.list.collapsed{max-height:0 !important; min-height:0 !important; opacity:0; overflow:hidden; padding:0; flex:0;}
		.list__item{margin:4px 0;}
		.link{display:block; padding:8px 10px; border-radius:6px; color:inherit; text-decoration:none;}
		.link:hover{background:#fff; box-shadow:inset 0 0 0 1px var(--border);}
		.link--active{background:#fff; box-shadow:inset 0 0 0 2px var(--accent);}
		.sidebar__footer{padding:12px; border-top:1px solid var(--border); font-size:13px; user-select:none;}
		.footer__title{margin:0 0 8px; font-size:14px; color:var(--muted); cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:4px 6px; border-radius:4px; transition:background .15s ease;}
		.footer__title:hover{background:rgba(0,0,0,.05);}
		.footer__title::after{content:'▼'; font-size:10px; color:var(--muted); transition:transform .2s ease;}
		.footer__title.collapsed::after{transform:rotate(-90deg);}
		.footer__content{max-height:2000px; transition:all .3s ease; overflow:hidden;}
		.footer__content.collapsed{max-height:0 !important; opacity:0; margin:0;}
		.search-row{display:flex; gap:6px; margin-top:6px;}
		.input{flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:6px; font-size:14px;}
		.btn{padding:8px 10px; border:1px solid var(--border); background:#fff; border-radius:6px; cursor:pointer; transition:.15s ease;}
		.btn:active{transform:translateY(1px);}
		.btn--primary{border-color:var(--accent); color:#fff; background:var(--accent);}
		.btn--primary:hover{filter:brightness(.95);}
		.btn--ghost{border-color:var(--accent); color:var(--accent); background:transparent;}
		.btn--ghost:hover{background:rgba(140,29,64,.1);}
		.mutedsm{font-size:12px; color:var(--muted);}
		.checkbox-group{margin-top:10px; padding:8px; background:#fff; border:1px solid var(--border); border-radius:8px; max-height:180px; overflow:auto; display:flex; flex-direction:column; gap:6px;}
		.checkbox-group__item{display:flex; align-items:flex-start; gap:6px; font-size:13px; line-height:1.4;}
		.checkbox-group__item input[type="checkbox"]{margin-top:2px; accent-color:var(--accent);}
		.notice{margin-top:8px; font-size:12px; color:var(--muted);}
		.content{flex:1; display:flex; flex-direction:column; background:#fff; min-height:0; position:relative;}
		.viewer-wrap{flex:1; position:relative; min-height:0;}
		.viewer{position:absolute; inset:0; width:100%; height:100%; border:0; background:#fff;}
		.floating-toggle{position:absolute; left:20px; top:20px; z-index:100; background:var(--accent); color:#fff; border:none; width:44px; height:44px; border-radius:50%; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.15); display:none; align-items:center; justify-content:center; font-size:20px; transition:all .2s ease;}
		.floating-toggle:hover{transform:scale(1.08); box-shadow:0 6px 16px rgba(0,0,0,.2);}
		.floating-toggle:active{transform:scale(.95);}
		.floating-toggle.visible{display:flex;}
		.search-panel{flex:1; display:flex; flex-direction:column; gap:16px; padding:20px 24px; background:#fff; min-height:0; overflow:auto;}
		.results__bar{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;}
		.results__heading{display:flex; flex-direction:column; gap:4px;}
		.results__title{margin:0; font-size:20px;}
		.results__hint{margin:0; font-size:13px; color:var(--muted);}
		.results__list{flex:1; overflow:auto; padding:12px 4px 12px 0; margin:0; display:flex; flex-direction:column; gap:14px;}
		.result{padding:12px 18px; border:1px solid var(--border); border-radius:10px; background:#fff; position:relative;}
		.result__header{display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; gap:12px;}
		.result__article{font-size:13px; color:var(--muted); margin:0; flex:1;}
		.result__goto{flex-shrink:0;}
		.result__excerpt{margin:0; line-height:1.6; font-size:14px;}
		.result__mark{background:rgba(140,29,64,.18); color:inherit; padding:0 2px; border-radius:2px;}
		.results__empty{margin:0; font-size:13px; color:var(--muted);}
		@media (max-width:768px){
			.layout{flex-direction:column; height:auto; min-height:calc(100vh - 86px);}
			.sidebar{width:100%; max-width:none; border-right:none; border-bottom:1px solid var(--border); height:auto;}
			.sidebar.hidden{transform:translateY(-100%); margin-left:0; margin-top:-100%;}
			.floating-toggle{left:auto; right:20px;}
		}
		@media (max-width:540px){
			.results__bar{flex-direction:column; align-items:flex-start;}
			.btn--ghost{width:100%;}
			.search-panel{padding:18px;}
		}
	</style>
</head>
<body>
	<header class="header">
		<h1 class="header__title">新出土戰國楚簡「孔子與時人對答」讀本</h1>
		<p class="header__meta">作者：陳曙光博士　｜　網頁開發者：樂林</p>
	</header>
	<div class="layout">
		<aside class="sidebar" aria-label="文章目錄與全文檢索">
			<div class="sidebar__header">
				<p id="catalog-toggle" class="section__title" style="flex:1; margin:0;">讀本目錄</p>
				<button id="sidebar-toggle" class="sidebar-toggle" type="button" title="收起側邊欄" aria-label="收起側邊欄">◀</button>
			</div>
			<ul id="article-list" class="list" aria-label="文章列表"></ul>
			<div class="sidebar__footer" aria-label="全文檢索區">
				<p id="search-toggle" class="footer__title">檢索文字</p>
				<div id="search-content" class="footer__content">
					<div class="search-row">
						<input id="search-input" class="input" type="text" placeholder="輸入欲檢索的文字…" aria-label="檢索文字輸入">
						<button id="search-btn" class="btn btn--primary" type="button">搜尋</button>
					</div>
					<div class="mutedsm" style="margin-top:12px;">勾選欲檢索的文章（可複選）</div>
					<div id="scope-checkboxes" class="checkbox-group" role="group" aria-label="檢索文章範圍"></div>
					<p class="notice">提示：若未勾選任何文章，將以目前閱讀的文章進行檢索。</p>
				</div>
			</div>
		</aside>
		<main class="content" aria-label="文章檢視與檢索結果">
			<button id="floating-toggle" class="floating-toggle" type="button" title="顯示側邊欄" aria-label="顯示側邊欄">▶</button>
			<div class="viewer-wrap">
				<iframe id="viewer" class="viewer" src="" title="文章內容預覽"></iframe>
			</div>
			<section id="search-panel" class="search-panel" aria-live="polite" hidden>
				<div class="results__bar">
					<div class="results__heading">
						<h2 class="results__title">檢索結果</h2>
						<p id="search-hint" class="results__hint">尚未進行檢索</p>
					</div>
					<button id="return-btn" class="btn btn--ghost" type="button">返回全文</button>
				</div>
				<div id="search-results" class="results__list">
					<p class="results__empty">執行搜尋後，相關段落會顯示於此。</p>
				</div>
			</section>
		</main>
	</div>
	<script>
		(function(){
			// 侧边栏显示/隐藏功能
			const sidebar = document.querySelector('.sidebar');
			const sidebarToggle = document.getElementById('sidebar-toggle');
			const floatingToggle = document.getElementById('floating-toggle');

			// 初始化侧边栏状态
			const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
			if (sidebarHidden) {
				sidebar.classList.add('hidden');
				floatingToggle.classList.add('visible');
			}

			// 切换侧边栏
			function toggleSidebar() {
				const isHidden = sidebar.classList.toggle('hidden');
				floatingToggle.classList.toggle('visible', isHidden);
				localStorage.setItem('sidebarHidden', isHidden);
			}

			sidebarToggle.addEventListener('click', toggleSidebar);
			floatingToggle.addEventListener('click', toggleSidebar);

			// 折叠/展开功能
			const catalogToggle = document.getElementById('catalog-toggle');
			const articleList = document.getElementById('article-list');
			const searchToggle = document.getElementById('search-toggle');
			const searchContent = document.getElementById('search-content');

			// 初始化折叠状态（从 localStorage 读取）
			const catalogCollapsed = localStorage.getItem('catalogCollapsed') === 'true';
			const searchCollapsed = localStorage.getItem('searchCollapsed') === 'true';

			if (catalogCollapsed) {
				catalogToggle.classList.add('collapsed');
				articleList.classList.add('collapsed');
			}

			if (searchCollapsed) {
				searchToggle.classList.add('collapsed');
				searchContent.classList.add('collapsed');
			}

			// 切换折叠状态
			catalogToggle.addEventListener('click', function() {
				const isCollapsed = catalogToggle.classList.toggle('collapsed');
				articleList.classList.toggle('collapsed');
				localStorage.setItem('catalogCollapsed', isCollapsed);
			});

			searchToggle.addEventListener('click', function() {
				const isCollapsed = searchToggle.classList.toggle('collapsed');
				searchContent.classList.toggle('collapsed');
				localStorage.setItem('searchCollapsed', isCollapsed);
			});

			// 主应用逻辑
			const articles = [
				{ title: "民之父母", path: "articles/民之父母.html" },
				{ title: "窮達以時", path: "articles/窮達以時.html" },
				{ title: "仲弓", path: "articles/仲弓.html" },
				{ title: "史蒥問於夫子", path: "articles/史蒥問於夫子.html" },
				{ title: "君子為禮", path: "articles/君子為禮.html" },
				{ title: "子羔", path: "articles/子羔.html" },
				{ title: "孔子見季桓子", path: "articles/孔子見季桓子.html" },
				{ title: "季庚子問於孔子", path: "articles/季庚子問於孔子.html" },
				{ title: "尊德義", path: "articles/尊德義.html" },
				{ title: "弟子問", path: "articles/弟子問.html" },
				{ title: "從政", path: "articles/從政.html" },
				{ title: "成之聞之", path: "articles/成之聞之.html" },
				{ title: "相邦之道", path: "articles/相邦之道.html" },
				{ title: "邦家之政", path: "articles/邦家之政.html" },
				{ title: "顏淵問於孔子", path: "articles/顏淵問於孔子.html" },
				{ title: "魯邦大旱", path: "articles/魯邦大旱.html" }
			];

			const listEl = document.getElementById('article-list');
			const iframe = document.getElementById('viewer');
			const searchInput = document.getElementById('search-input');
			const searchBtn = document.getElementById('search-btn');
			const scopeGroup = document.getElementById('scope-checkboxes');
			const hintEl = document.getElementById('search-hint');
			const resultsEl = document.getElementById('search-results');
			const viewerWrap = document.querySelector('.viewer-wrap');
			const searchPanel = document.getElementById('search-panel');
			const returnBtn = document.getElementById('return-btn');

			let currentIndex = 0;

			function showViewer(){
				viewerWrap.removeAttribute('hidden');
				searchPanel.setAttribute('hidden','');
			}

			function showSearchPanel(){
				searchPanel.removeAttribute('hidden');
				viewerWrap.setAttribute('hidden','');
			}

			function setHint(text){
				hintEl.textContent = text;
			}

			function renderList() {
				listEl.innerHTML = "";
				articles.forEach((a, idx) => {
					const li = document.createElement('li');
					li.className = 'list__item';
					const link = document.createElement('a');
					link.href = '#';
					link.textContent = a.title;
					link.className = 'link' + (idx === currentIndex ? ' link--active' : '');
					link.addEventListener('click', (e) => {
						e.preventDefault();
						if (currentIndex !== idx) {
							currentIndex = idx;
							loadArticle();
							renderList();
							renderScope();
							showViewer();
							setHint("已切換至《" + a.title + "》");
						}
					});
					li.appendChild(link);
					listEl.appendChild(li);
				});
			}

			function renderScope() {
				scopeGroup.innerHTML = "";
				articles.forEach((a, idx) => {
					const wrapper = document.createElement('label');
					wrapper.className = 'checkbox-group__item';
					const checkbox = document.createElement('input');
					checkbox.type = 'checkbox';
					checkbox.value = String(idx);
					checkbox.name = 'scope';
					if (idx === currentIndex) {
						checkbox.checked = true;
					}
					const text = document.createElement('span');
					text.textContent = a.title;
					wrapper.appendChild(checkbox);
					wrapper.appendChild(text);
					scopeGroup.appendChild(wrapper);
				});
			}

			function loadArticle() {
				const art = articles[currentIndex];
				iframe.src = art.path;
			}

			function escapeRegExp(str) {
				return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
			}

			// 从文章 HTML 中提取图片配置
			function extractImageConfig(doc) {
				const imagePaths = new Map();
				const imageConfig = doc.getElementById('image-config');
				if (imageConfig) {
					const configItems = imageConfig.querySelectorAll('div[data-label][data-path]');
					configItems.forEach(item => {
						const label = item.getAttribute('data-label');
						const path = item.getAttribute('data-path');
						if (label && path) {
							imagePaths.set(label, path);
						}
					});
				}
				return imagePaths;
			}

			// 将文本中的占位符替换为图片 HTML
			function processGlyphPlaceholders(text, imagePaths, articleBasePath) {
				// 获取文章所在目录（用于拼接图片路径）
				const baseDir = articleBasePath.substring(0, articleBasePath.lastIndexOf('/') + 1);
				
				let result = text;
				let counter = 1;
				const pad = (num) => String(num).padStart(3, '0');
				
				// 先处理带序号的格式 [圖字XXX]
				result = result.replace(/\[圖字(\d{3})\]/g, (match, num) => {
					const label = `圖字${num}`;
					const imagePath = imagePaths.get(label);
					if (imagePath) {
						return `<img src="${baseDir}${imagePath}" alt="${label}" style="max-height:1.6em;vertical-align:middle;margin:0 0.12em;display:inline-block;" onerror="this.outerHTML='<span style=\\'display:inline-flex;align-items:center;justify-content:center;min-width:1.2em;height:1.4em;padding:0.1em 0.3em;margin:0 0.12em;border:1px dashed rgba(180,32,32,0.6);background-color:rgba(255,228,232,0.45);border-radius:0.35em;font-weight:600;color:#8c1d40;font-size:0.85em;\\'>${label}</span>'">`;
					} else {
						return `<span style="display:inline-flex;align-items:center;justify-content:center;min-width:1.2em;height:1.4em;padding:0.1em 0.3em;margin:0 0.12em;border:1px dashed rgba(180,32,32,0.6);background-color:rgba(255,228,232,0.45);border-radius:0.35em;font-weight:600;color:#8c1d40;font-size:0.85em;">${label}</span>`;
					}
				});
				
				// 再处理普通格式 []
				result = result.replace(/\[\]/g, () => {
					const label = `圖字${pad(counter)}`;
					counter++;
					const imagePath = imagePaths.get(label);
					if (imagePath) {
						return `<img src="${baseDir}${imagePath}" alt="${label}" style="max-height:1.6em;vertical-align:middle;margin:0 0.12em;display:inline-block;" onerror="this.outerHTML='<span style=\\'display:inline-flex;align-items:center;justify-content:center;min-width:1.2em;height:1.4em;padding:0.1em 0.3em;margin:0 0.12em;border:1px dashed rgba(180,32,32,0.6);background-color:rgba(255,228,232,0.45);border-radius:0.35em;font-weight:600;color:#8c1d40;font-size:0.85em;\\'>${label}</span>'">`;
					} else {
						return `<span style="display:inline-flex;align-items:center;justify-content:center;min-width:1.2em;height:1.4em;padding:0.1em 0.3em;margin:0 0.12em;border:1px dashed rgba(180,32,32,0.6);background-color:rgba(255,228,232,0.45);border-radius:0.35em;font-weight:600;color:#8c1d40;font-size:0.85em;">${label}</span>`;
					}
				});
				
				return result;
			}

			function getSelectedScopeIndices() {
				return Array.from(scopeGroup.querySelectorAll('input[type="checkbox"]:checked'))
					.map(input => parseInt(input.value, 10))
					.filter(idx => Number.isInteger(idx) && idx >= 0 && idx < articles.length);
			}

			async function runSearch() {
				const query = searchInput.value.trim();
				if (!query) {
					setHint("請輸入檢索詞。");
					resultsEl.innerHTML = '<p class="results__empty">尚未輸入檢索詞。</p>';
					showViewer();
					return;
				}

				const selectedIndices = getSelectedScopeIndices();
				const articleIndices = selectedIndices.length ? selectedIndices : [currentIndex];

				resultsEl.innerHTML = '<p class="results__empty">檢索中，請稍候…</p>';
				setHint("檢索中…");
				showSearchPanel();

				const results = [];

				for (const idx of articleIndices) {
					const art = articles[idx];
					try {
						const response = await fetch(art.path);
						if (!response.ok) throw new Error("無法載入文章：《" + art.title + "》");
						const htmlText = await response.text();
						const parser = new DOMParser();
						const doc = parser.parseFromString(htmlText, "text/html");

						// 提取图片配置（在移除 script 之前）
						const imagePaths = extractImageConfig(doc);

						// 移除 script 和 style 标签
						const scripts = doc.querySelectorAll('script, style');
						scripts.forEach(el => el.remove());

						// 扩大检索范围，包括 main 中的所有文本内容
						const mainContent = doc.querySelector('main');
						if (mainContent) {
							// 查找所有包含文本的元素（优先查找 transcription-block 中的内容）
							const segments = Array.from(mainContent.querySelectorAll('p, li, blockquote, h1, h2, h3, h4'));
							
							// 如果没找到，尝试直接获取 main 的文本
							if (segments.length === 0) {
								const allText = mainContent.textContent || "";
								if (allText.includes(query)) {
									// 创建正则表达式进行匹配和标记
									const pattern = new RegExp(escapeRegExp(query), 'gi');
									const marked = allText.replace(pattern, (match) => `<mark class="result__mark">${match}</mark>`);
									// 截取包含查询词的部分（前后各100字符）
									const matchIndex = allText.toLowerCase().indexOf(query.toLowerCase());
									if (matchIndex !== -1) {
										const start = Math.max(0, matchIndex - 100);
										const end = Math.min(allText.length, matchIndex + query.length + 100);
										let excerpt = '...' + marked.substring(start, end) + '...';
										// 应用图片替换
										excerpt = processGlyphPlaceholders(excerpt, imagePaths, art.path);
										results.push({
											articleIndex: idx,
											articleTitle: art.title,
											articlePath: art.path,
											excerpt: excerpt,
											query: query
										});
									}
								}
							} else {
								segments.forEach((node) => {
									const text = node.textContent || "";
									if (!text.trim()) return;
									
									// 检查是否包含查询词（不区分大小写）
									if (text.toLowerCase().includes(query.toLowerCase())) {
										// 创建新的正则表达式实例，避免 lastIndex 问题
										const pattern = new RegExp(escapeRegExp(query), 'gi');
										let marked = text.replace(pattern, (match) => `<mark class="result__mark">${match}</mark>`);
										// 应用图片替换
										marked = processGlyphPlaceholders(marked, imagePaths, art.path);
										results.push({
											articleIndex: idx,
											articleTitle: art.title,
											articlePath: art.path,
											excerpt: marked,
											query: query
										});
									}
								});
							}
						} else {
							// 如果没有 main 标签，使用原来的方法
							const segments = Array.from(doc.querySelectorAll('p, li, blockquote, h1, h2, h3, h4'));
							segments.forEach((node) => {
								const text = node.textContent || "";
								if (!text.trim()) return;
								
								if (text.toLowerCase().includes(query.toLowerCase())) {
									const pattern = new RegExp(escapeRegExp(query), 'gi');
									let marked = text.replace(pattern, (match) => `<mark class="result__mark">${match}</mark>`);
									// 应用图片替换
									marked = processGlyphPlaceholders(marked, imagePaths, art.path);
									results.push({
										articleIndex: idx,
										articleTitle: art.title,
										articlePath: art.path,
										excerpt: marked,
										query: query
									});
								}
							});
						}
					} catch (err) {
						results.push({
							articleIndex: idx,
							articleTitle: art.title,
							articlePath: art.path,
							excerpt: `<span style="color:#b00020;">${err.message}</span>`,
							query: query
						});
					}
				}

				if (!results.length) {
					resultsEl.innerHTML = `<p class="results__empty">未找到包含「${query}」的段落。</p>`;
					setHint("未找到相關內容。");
					return;
				}

				const frag = document.createDocumentFragment();
				results.forEach((item) => {
					const wrapper = document.createElement('article');
					wrapper.className = 'result';
					
					// 创建标题和按钮的容器
					const header = document.createElement('div');
					header.className = 'result__header';
					
					const title = document.createElement('p');
					title.className = 'result__article';
					title.textContent = "文章：《" + item.articleTitle + "》";
					
					// 创建"前往该文"按钮
					const gotoBtn = document.createElement('button');
					gotoBtn.className = 'btn btn--ghost result__goto';
					gotoBtn.textContent = '前往该文';
					gotoBtn.type = 'button';
					gotoBtn.addEventListener('click', () => {
						// 切换到对应文章
						if (item.articleIndex !== undefined && item.articleIndex !== currentIndex) {
							currentIndex = item.articleIndex;
							loadArticle();
							renderList();
							renderScope();
						} else if (item.articlePath) {
							// 如果索引不存在，通过路径查找
							const foundIdx = articles.findIndex(a => a.path === item.articlePath);
							if (foundIdx !== -1 && foundIdx !== currentIndex) {
								currentIndex = foundIdx;
								loadArticle();
								renderList();
								renderScope();
							}
						}
						
						// 显示文章视图
						showViewer();
						
						// 等待iframe加载完成后定位到相关位置
						if (item.query) {
							// 监听iframe加载完成事件
							const handleLoad = () => {
								setTimeout(() => {
									scrollToQueryInIframe(item.query);
								}, 300);
								iframe.removeEventListener('load', handleLoad);
							};
							iframe.addEventListener('load', handleLoad);
							// 如果iframe已经加载完成，立即执行
							if (iframe.contentDocument && iframe.contentDocument.readyState === 'complete') {
								handleLoad();
							}
						}
					});
					
					header.appendChild(title);
					header.appendChild(gotoBtn);
					
					const excerpt = document.createElement('p');
					excerpt.className = 'result__excerpt';
					excerpt.innerHTML = item.excerpt;
					
					wrapper.appendChild(header);
					wrapper.appendChild(excerpt);
					frag.appendChild(wrapper);
				});
				resultsEl.innerHTML = "";
				resultsEl.appendChild(frag);
				setHint("找到 " + results.length + " 筆結果。");
			}

			// 在iframe中滚动到包含查询词的位置
			function scrollToQueryInIframe(query) {
				try {
					const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
					if (!iframeDoc || !iframeDoc.body) return;
					
					// 先尝试查找所有包含查询词的段落元素
					const allElements = iframeDoc.querySelectorAll('p, li, blockquote, h1, h2, h3, h4, span, div');
					let foundElement = null;
					
					for (const elem of allElements) {
						const text = elem.textContent || '';
						if (text.toLowerCase().includes(query.toLowerCase())) {
							foundElement = elem;
							break;
						}
					}
					
					if (foundElement) {
						// 高亮显示匹配的文本
						const text = foundElement.textContent || '';
						const matchIndex = text.toLowerCase().indexOf(query.toLowerCase());
						if (matchIndex !== -1) {
							// 尝试在元素内高亮文本
							const walker = iframeDoc.createTreeWalker(
								foundElement,
								NodeFilter.SHOW_TEXT,
								null
							);
							
							let textNode;
							let currentPos = 0;
							while (textNode = walker.nextNode()) {
								const nodeText = textNode.textContent || '';
								const nodeStart = currentPos;
								const nodeEnd = currentPos + nodeText.length;
								
								if (matchIndex >= nodeStart && matchIndex < nodeEnd) {
									// 在这个文本节点中找到匹配
									const range = iframeDoc.createRange();
									const localIndex = matchIndex - nodeStart;
									range.setStart(textNode, localIndex);
									range.setEnd(textNode, Math.min(localIndex + query.length, nodeText.length));
									
									// 创建高亮标记
									const mark = iframeDoc.createElement('mark');
									mark.style.backgroundColor = 'rgba(140,29,64,.3)';
									mark.style.padding = '2px 4px';
									mark.style.borderRadius = '3px';
									mark.style.transition = 'background-color 0.3s ease';
									
									try {
										range.surroundContents(mark);
										// 3秒后移除高亮
										setTimeout(() => {
											if (mark.parentNode) {
												const parent = mark.parentNode;
												parent.replaceChild(iframeDoc.createTextNode(mark.textContent), mark);
												parent.normalize();
											}
										}, 3000);
									} catch (e) {
										// 如果surroundContents失败，跳过
										console.warn('无法高亮文本:', e);
									}
									break;
								}
								currentPos = nodeEnd;
							}
						}
						
						// 滚动到元素位置
						foundElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
					} else {
						// 如果没找到元素，尝试在整个文档中查找文本节点
						const walker = iframeDoc.createTreeWalker(
							iframeDoc.body,
							NodeFilter.SHOW_TEXT,
							null
						);
						
						let textNode;
						while (textNode = walker.nextNode()) {
							if (textNode.textContent && textNode.textContent.toLowerCase().includes(query.toLowerCase())) {
								let element = textNode.parentElement;
								while (element && (!element.offsetParent || element === iframeDoc.body)) {
									element = element.parentElement;
								}
								
								if (element && element !== iframeDoc.body) {
									element.scrollIntoView({ behavior: 'smooth', block: 'center' });
									break;
								}
							}
						}
					}
				} catch (err) {
					console.warn('无法定位到查询位置:', err);
				}
			}

			searchBtn.addEventListener('click', runSearch);
			searchInput.addEventListener('keydown', (e) => {
				if (e.key === 'Enter') runSearch();
			});
			returnBtn.addEventListener('click', () => {
				showViewer();
				setHint("尚未進行檢索");
			});

			renderList();
			renderScope();
			loadArticle();
		})();
	</script>
</body>
</html>